name: Release Kraken API

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - develop

permissions:
  contents: write
  packages: write

jobs:
  build-release:
    environment: Prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag operations

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Calculate version
        run: |
          # Read base version from file
          BASE_VERSION=$(cat version.txt | tr -d '[:space:]')
          
          # Extract major.minor from base version (e.g., "1.1" from "1.1.0")
          MAJOR_MINOR=$(echo $BASE_VERSION | cut -d. -f1,2)
          
          # test build 1.1.1
          
          # Check if base version tag already exists
          if git rev-parse "refs/tags/${BASE_VERSION}" >/dev/null 2>&1; then
            # Base version exists, find the highest patch number
            LAST_TAG=$(git tag -l "${MAJOR_MINOR}.*" --sort=-version:refname | head -n 1)
            LAST_PATCH=$(echo $LAST_TAG | awk -F. '{print $NF}')
            PATCH=$((LAST_PATCH + 1))
            VERSION="${MAJOR_MINOR}.${PATCH}"
          else
            # Base version doesn't exist yet, use it as-is
            VERSION="${BASE_VERSION}"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Calculated version: $VERSION"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build project
        run: |
          echo "Building project with version $VERSION"
          chmod +x ./gradlew
          ./gradlew clean build

      - name: Collect commit messages since last tag
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s")
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s")
          fi
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: ${{ env.COMMITS }}

      - name: Publish to GitHub Packages
        run: |
          echo "Publishing version $VERSION to GitHub Packages"
          ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install MinIO client
        run: |
          wget https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          sudo mv mc /usr/local/bin/

      - name: Configure MinIO client
        run: |
          mc alias set s3 ${{secrets.MINIO_URL}} ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }}

      - name: Upload JAR to MinIO
        run: |
          JAR_FILE=$(find lib/build/libs -name "kraken-api-*.jar" | head -n 1)
          echo "Uploading $JAR_FILE to MinIO..."
          mc cp "$JAR_FILE" s3/kraken-bootstrap-static/api/kraken-api-${VERSION}.jar

      - name: Upload hooks.json file in MinIO
        run: |
          echo "Uploading hooks.json to MinIO..."
          mc cp "./hooks.json" s3/kraken-bootstrap-static/hooks.json